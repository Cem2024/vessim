<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>vessim.sil.sil_interface API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>vessim.sil.sil_interface</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">from threading import Thread
from typing import List, Optional

from vessim.core.storage import SimpleBattery, DefaultStoragePolicy, StoragePolicy
from vessim.cosim._util import VessimSimulator, VessimModel, simplify_inputs
from vessim.sil.api_server import ApiServer, VessimApi
from vessim.sil.http_client import HttpClient
from vessim.sil.node import Node
from vessim.sil.loop_thread import LoopThread


class SilInterfaceSim(VessimSimulator):
    &#34;&#34;&#34;Software-in-the-Loop (SiL) interface simulator that executes the model.&#34;&#34;&#34;

    META = {
        &#34;type&#34;: &#34;time-based&#34;,
        &#34;models&#34;: {
            &#34;SilInterface&#34;: {
                &#34;public&#34;: True,
                &#34;any_inputs&#34;: True,
                &#34;params&#34;: [
                    &#34;nodes&#34;,
                    &#34;battery&#34;,
                    &#34;policy&#34;,
                    &#34;collection_interval&#34;,
                    &#34;api_host&#34;,
                    &#34;api_port&#34;
                ],
                &#34;attrs&#34;: []
            },
        },
    }

    def __init__(self) -&gt; None:
        self.step_size = None
        super().__init__(self.META, _SilInterfaceModel)

    def init(self, sid, time_resolution, step_size, eid_prefix=None):
        self.step_size = step_size
        return super().init(sid, time_resolution, eid_prefix=eid_prefix)

    def finalize(self) -&gt; None:
        &#34;&#34;&#34;Stops the api server and the collector thread when the simulation finishes.&#34;&#34;&#34;
        super().finalize()
        for model_instance in self.entities.values():
            model_instance.collector_thread.stop() # type: ignore
            model_instance.collector_thread.join() # type: ignore
            model_instance.http_client.put(&#34;/shutdown&#34;) # type: ignore
            model_instance.api_server.terminate() # type: ignore
            model_instance.api_server.join() # type: ignore

    def next_step(self, time):
        return time + self.step_size


class _SilInterfaceModel(VessimModel):
    &#34;&#34;&#34;Software-in-the-Loop interface to the energy system simulation.

    TODO this class is still very specific to our paper use case and does not
    generalize well to other scenarios.

    Args:
        nodes: List of vessim SiL nodes.
        battery: SimpleBattery battery used by the system.
        policy: The (dis)charging policy used to control the battery.
        nodes: List of physical or virtual computing nodes.
        collection_interval: Interval in which `/sim/collet-set` in fetched from
            the API server.
        api_host: Server address for the API.
        api_port: Server port for the API.
    &#34;&#34;&#34;

    def __init__(
        self,
        nodes: List[Node],
        battery: SimpleBattery,
        collection_interval: float,
        policy: Optional[StoragePolicy] = None,
        api_host: str = &#34;127.0.0.1&#34;,
        api_port: int = 8000
    ):
        self.nodes = nodes
        self.updated_nodes: List[Node] = []
        self.battery = battery
        self.policy = policy if policy is not None else DefaultStoragePolicy()
        self.p_cons = 0
        self.p_gen = 0
        self.p_grid = 0
        self.ci = 0

        # start server process
        self.api_server = ApiServer(VessimApi, api_host, api_port)
        self.api_server.start()
        self.api_server.wait_for_startup_complete()

        # init server values and wait for put request confirmation
        self.http_client = HttpClient(f&#34;http://{api_host}:{api_port}&#34;)
        self.http_client.put(&#34;/sim/update&#34;, {
            &#34;solar&#34;: self.p_gen,
            &#34;ci&#34;: self.ci,
            &#34;battery_soc&#34;: self.battery.soc(),
        })

        self.collector_thread = LoopThread(self._api_collector, collection_interval)
        self.collector_thread.start()

    def _api_collector(self):
        &#34;&#34;&#34;Collects data from the API server.

        The endpoint &#34;/sim/collect-set&#34; yields the 3 fields `battery_min_soc`,
        `battery_grid_charge` and `nodes_power_mode`. Since multiple set
        request of these values from different actors are possible, each of
        these fields is a list of dictionaries with the timestamp (formated as
        `datetime.now().isoformat()`) and the set value at that time.

        TODO implement user defined collection method. Current static
        collection method: most recent entry.
        &#34;&#34;&#34;
        collection = self.http_client.get(&#34;/sim/collect-set&#34;)

        # The value of the keys is None by default if no set request was made
        # by an actor =&gt; Check if not None first.
        if collection[&#34;battery_min_soc&#34;]:
            # The newest entry is the one with the highest iso timestamp.
            newest_key = max(collection[&#34;battery_min_soc&#34;].keys())
            self.battery.min_soc = float(collection[&#34;battery_min_soc&#34;][newest_key])

        if collection[&#34;battery_grid_charge&#34;]:
            newest_key = max(collection[&#34;battery_grid_charge&#34;].keys())
            self.policy.grid_power = float(collection[&#34;battery_grid_charge&#34;][newest_key])

        if collection[&#34;nodes_power_mode&#34;]:
            newest_key = max(collection[&#34;nodes_power_mode&#34;].keys())
            nodes_power_mode = dict(collection[&#39;nodes_power_mode&#39;][newest_key].items())
            # nodes_power_mode looks e.g. like {&#34;gcp&#34;: &#34;normal&#34;,...}
            # Loop through all nodes,
            for node in self.nodes:
                if node.id in nodes_power_mode:
                    # update the power_mode if it changed
                    node.power_mode = nodes_power_mode[node.id]
                    # and save whatever node had its powermode updated to
                    # remotely update only that nodes&#39; power mode in step().
                    self.updated_nodes.append(node)

    def step(self, time: int, inputs: dict) -&gt; None:
        self.collector_thread.propagate_exception()
        inputs = simplify_inputs(inputs)
        self.p_cons = inputs[&#34;p_cons&#34;]
        self.p_gen = inputs[&#34;p_gen&#34;]
        self.ci = inputs[&#34;ci&#34;]
        self.p_grid = inputs[&#34;p_grid&#34;]

        # update values to the api server
        def update_api_server():
            self.http_client.put(&#34;/sim/update&#34;, {
                &#34;solar&#34;: self.p_gen,
                &#34;ci&#34;: self.ci,
                &#34;battery_soc&#34;: self.battery.soc(),
            })
        # use thread to not slow down simulation
        api_server_update_thread = Thread(target=update_api_server)
        api_server_update_thread.start()

        # update power mode for the node remotely
        for node in self.updated_nodes:
            http_client = HttpClient(f&#34;{node.address}:{node.port}&#34;)

            def update_node_power_model():
                http_client.put(&#34;/power_mode&#34;, {&#34;power_mode&#34;: node.power_mode})
            # use thread to not slow down simulation
            node_update_thread = Thread(target=update_node_power_model)
            node_update_thread.start()
        self.updated_nodes.clear()</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="vessim.sil.sil_interface.SilInterfaceSim"><code class="flex name class">
<span>class <span class="ident">SilInterfaceSim</span></span>
</code></dt>
<dd>
<div class="desc"><p>Software-in-the-Loop (SiL) interface simulator that executes the model.</p>
<p>Initialization of a basic simulator with given model.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>meta</code></strong></dt>
<dd>A dictionary that describes the simulator's metadata.</dd>
<dt><strong><code>model_class</code></strong></dt>
<dd>The class of the model to be simulated. Model requires
step() method with no args (must only utilize object
attributes). Alternatively, the step() method of this class
must be overwritten and implemented individually.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class SilInterfaceSim(VessimSimulator):
    &#34;&#34;&#34;Software-in-the-Loop (SiL) interface simulator that executes the model.&#34;&#34;&#34;

    META = {
        &#34;type&#34;: &#34;time-based&#34;,
        &#34;models&#34;: {
            &#34;SilInterface&#34;: {
                &#34;public&#34;: True,
                &#34;any_inputs&#34;: True,
                &#34;params&#34;: [
                    &#34;nodes&#34;,
                    &#34;battery&#34;,
                    &#34;policy&#34;,
                    &#34;collection_interval&#34;,
                    &#34;api_host&#34;,
                    &#34;api_port&#34;
                ],
                &#34;attrs&#34;: []
            },
        },
    }

    def __init__(self) -&gt; None:
        self.step_size = None
        super().__init__(self.META, _SilInterfaceModel)

    def init(self, sid, time_resolution, step_size, eid_prefix=None):
        self.step_size = step_size
        return super().init(sid, time_resolution, eid_prefix=eid_prefix)

    def finalize(self) -&gt; None:
        &#34;&#34;&#34;Stops the api server and the collector thread when the simulation finishes.&#34;&#34;&#34;
        super().finalize()
        for model_instance in self.entities.values():
            model_instance.collector_thread.stop() # type: ignore
            model_instance.collector_thread.join() # type: ignore
            model_instance.http_client.put(&#34;/shutdown&#34;) # type: ignore
            model_instance.api_server.terminate() # type: ignore
            model_instance.api_server.join() # type: ignore

    def next_step(self, time):
        return time + self.step_size</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li>vessim.cosim._util.VessimSimulator</li>
<li>mosaik_api.Simulator</li>
<li>abc.ABC</li>
</ul>
<h3>Class variables</h3>
<dl>
<dt id="vessim.sil.sil_interface.SilInterfaceSim.META"><code class="name">var <span class="ident">META</span></code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="vessim.sil.sil_interface.SilInterfaceSim.finalize"><code class="name flex">
<span>def <span class="ident">finalize</span></span>(<span>self) ‑> None</span>
</code></dt>
<dd>
<div class="desc"><p>Stops the api server and the collector thread when the simulation finishes.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def finalize(self) -&gt; None:
    &#34;&#34;&#34;Stops the api server and the collector thread when the simulation finishes.&#34;&#34;&#34;
    super().finalize()
    for model_instance in self.entities.values():
        model_instance.collector_thread.stop() # type: ignore
        model_instance.collector_thread.join() # type: ignore
        model_instance.http_client.put(&#34;/shutdown&#34;) # type: ignore
        model_instance.api_server.terminate() # type: ignore
        model_instance.api_server.join() # type: ignore</code></pre>
</details>
</dd>
<dt id="vessim.sil.sil_interface.SilInterfaceSim.init"><code class="name flex">
<span>def <span class="ident">init</span></span>(<span>self, sid, time_resolution, step_size, eid_prefix=None)</span>
</code></dt>
<dd>
<div class="desc"><p>Initialize Simulator and set <code>step_size</code> and <code>eid_prefix</code>.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def init(self, sid, time_resolution, step_size, eid_prefix=None):
    self.step_size = step_size
    return super().init(sid, time_resolution, eid_prefix=eid_prefix)</code></pre>
</details>
</dd>
<dt id="vessim.sil.sil_interface.SilInterfaceSim.next_step"><code class="name flex">
<span>def <span class="ident">next_step</span></span>(<span>self, time)</span>
</code></dt>
<dd>
<div class="desc"><p>Return time of next simulation step (None for event-based).</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def next_step(self, time):
    return time + self.step_size</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="vessim.sil" href="index.html">vessim.sil</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="vessim.sil.sil_interface.SilInterfaceSim" href="#vessim.sil.sil_interface.SilInterfaceSim">SilInterfaceSim</a></code></h4>
<ul class="">
<li><code><a title="vessim.sil.sil_interface.SilInterfaceSim.META" href="#vessim.sil.sil_interface.SilInterfaceSim.META">META</a></code></li>
<li><code><a title="vessim.sil.sil_interface.SilInterfaceSim.finalize" href="#vessim.sil.sil_interface.SilInterfaceSim.finalize">finalize</a></code></li>
<li><code><a title="vessim.sil.sil_interface.SilInterfaceSim.init" href="#vessim.sil.sil_interface.SilInterfaceSim.init">init</a></code></li>
<li><code><a title="vessim.sil.sil_interface.SilInterfaceSim.next_step" href="#vessim.sil.sil_interface.SilInterfaceSim.next_step">next_step</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>